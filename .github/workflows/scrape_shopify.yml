- name: Upload CSV to Google Drive
        run:|
          cat <<EOF > upload_to_drive.py

import os
from pydrive2.auth import GoogleAuth
from pydrive2.drive import GoogleDrive

gauth = GoogleAuth()
gauth.LoadServiceConfigSettings()
gauth.AuthFromServiceAccount()
drive = GoogleDrive(gauth)
folder_id = "15gVrByonzFvBMGxJ4NUvVXzCgEUVB1Se"
csv_filename = os.getenv("CSV_FILENAME")

if not csv_filename or not os.path.exists(csv_filename):
    print(f"Error: CSV file not found or filename not provided: {csv_filename}")
    exit(1)

print(f"Uploading: {csv_filename} to Google Drive folder {folder_id}")

file_list = drive.ListFile({"q": f"'{folder_id}' in parents and trashed=false"}).GetList()
existing_file_id = None
for file_in_drive in file_list:
    if file_in_drive["title"] == csv_filename:
        existing_file_id = file_in_drive["id"]
        break

if existing_file_id:
    file_to_upload = drive.CreateFile({"id": existing_file_id})
    file_to_upload.SetContentFile(csv_filename)
    file_to_upload.Upload()
    print(f"Updated: {csv_filename}")
else:
    file_to_upload = drive.CreateFile({
        "title": csv_filename,
        "parents": [{"id": folder_id}]
    })
    file_to_upload.SetContentFile(csv_filename)
    file_to_upload.Upload()
    print(f"Created: {csv_filename}")
EOF
          python upload_to_drive.py
        env:
          CSV_FILENAME: ${{ steps.run_script.outputs.csv_file }}
